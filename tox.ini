# Tox config for local dev, GitHub Actions CI, and PyPI preflight checks
# Requires tox >= 4
[tox]
min_version = 4.8
envlist =
    py{311,312}-{auto,off}
    lint
    fmt
    type
    build
isolated_build = True

[testenv]
description = Run unit tests ({envname})
package = wheel
wheel_build_env = .pkg
passenv =
    CI
    GITHUB_*
    PIP_INDEX_URL
    REQUESTS_CA_BUNDLE
    SSL_CERT_FILE
setenv =
    PYTHONWARNINGS = default
    auto: MATRIX_SSL_TRUST = auto
    off: MATRIX_SSL_TRUST = off
deps =
    .[dev]
commands =
    pytest -q {posargs}

[testenv:lint]
description = Lint with ruff
skip_install = true
deps = ruff>=0.12,<0.13
commands = ruff check .

[testenv:fmt]
description = Enforce formatting with black
skip_install = true
deps = black>=24.0.0
commands = black --check .

[testenv:type]
description = Static type-checking with mypy
deps = .[dev]
commands = mypy matrix_sdk tests

[testenv:build]
description = Build sdist/wheel and validate with twine (no upload)
skip_install = true
deps =
    build
    twine
commands =
    python -c "import shutil, pathlib; shutil.rmtree('dist', ignore_errors=True); pathlib.Path('dist').mkdir(exist_ok=True)"
    python -m build
    python -m twine check dist/*
